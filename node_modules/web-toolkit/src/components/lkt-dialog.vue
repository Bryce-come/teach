<script lang="tsx">
import Vue, { VNodeChildren, ComponentOptions, VueConstructor } from 'vue';
import { ref, onMounted } from '@vue/composition-api';
import { deepClone, kebabToPascal, isArray, isUndefined } from '../utils';
import { ElForm } from 'element-ui/types/form';
import { VNodeDataMap } from '../utils/lkt-dialog';
export default Vue.extend({
  props: {
    title: String,
    renderContent: Function,
    render: Function,
    submit: Function,
    setup: Function,
    width: String,
    beforeClose: Function,
    showActionButton: {
      type: Boolean,
      default: true,
    },
    actionButtonText: String,
    validate: {
      type: Boolean,
      default: true,
    },
  },
  setup(props: Record<string, any>, ctx) {
    let bindings: any;
    const form = ref<ElForm>();
    if (props.setup) {
      bindings = props.setup(ctx);
    }
    const show = ref(false);
    const close = async (data: any) => {
      if (props.beforeClose) {
        const result = props.beforeClose();
        if (!result) {
          return;
        }
      }
      if (data && props.validate) {
        if (!form.value) {
          console.error(`Can't find the ref "form" to validate. typeof it is ${typeof form.value}`);
          return;
        }
        const valid = await form.value.validate();
        if (!valid) {
          return;
        }
      }
      props.submit(data);
      show.value = false;
      Vue.nextTick(() => {
        ctx.root.$destroy();
      });
    };
    onMounted(() => {
      show.value = true;
    });
    return {
      show,
      close,
      form,
      ...(bindings || {}),
    };
  },
  render(this: any, h) {
    const futureH = (tag: string, data: VNodeDataMap = {}, children?: VNodeChildren) => {
      function toLowerCaseFirstLetter(str: string) {
        const r = str.slice(1);
        return str[0].toLowerCase() + r;
      }
      // todo 区分扁平化的prop和attr
      const props: Record<string, any> = data.props || {};
      const domProps: Record<string, any> = data.domProps || {};
      const attrs: Record<string, any> = data.attrs || {};
      const on: Record<string, any> = data.on || {};
      const nativeOn: Record<string, any> = data.nativeOn || {};
      const builtInKey = ['on', 'attrs', 'props', 'key', 'ref', 'scopedSlots', 'slot', 'class', 'style', 'refInFor', 'directives', 'nativeOn', 'domProps'];
      for (const [key, val] of Object.entries(data)) {
        if (!builtInKey.includes(key)) {
          const lower = key.toLowerCase();
          if (lower.startsWith('on')) {
            on[toLowerCaseFirstLetter(key.replace(/^([oO]n)/, ''))] = val;
          } else if (lower.startsWith('nativeon')) {
            nativeOn[toLowerCaseFirstLetter(key.replace(/^(native[oO]n)/, ''))] = val;
          } else if (lower.startsWith('dom')) {
            domProps[toLowerCaseFirstLetter(key.replace(/^([dD][oO][mM])/, ''))] = val;
          } else {
            const component = resolveComponent(tag);
            if (component && isComponentProp(component, key)) {
              props[key] = val;
            } else {
              attrs[key] = val;
            }
          }
        }
      }
      return h(tag, {
        ...data, props, attrs, domProps, on, nativeOn,
      }, children);
    };
    return (
      <transition name='fade'>
        { this.show &&
        <lkt-scrollbar class='lkt-dialog--modal' innerClass='flex' innerStyle='justify-content: center; background-color: rgba(0, 0, 0, .3); align-items: flex-start;'>
          <div class='lkt-dialog' style={ { width: this.width } }>
            <div class='lkt-dialog--header'>
              <span>{ this.title }</span>
              <el-button type='danger' size='mini' icon='el-icon-close' onClick={ () => this.close() }></el-button>
            </div>
            <div class='lkt-dialog--body'>
              { this.render ? this.render.call(this, h, this.formModel) : this.renderContent.call(this, futureH, this.formModel) }
            </div>
            { this.showActionButton && <div class='lkt-dialog--footer flex center little-space'>
              <el-button type='primary' onClick={ () => this.close(this.formModel) }>{ this.actionButtonText || '确定' }</el-button>
            </div> }
          </div>
        </lkt-scrollbar> }
      </transition>
    );
  },
});
function resolveComponent(cpt: string) {
  // @ts-ignore
  const components = Vue.options.components as Record<string, VueConstructor | void>;
  for (const [name, component] of Object.entries(components)) {
    if (kebabToPascal(name) === kebabToPascal(cpt)) {
      return component;
    }
  }
}
function isComponentProp(component: VueConstructor, prop: string) {
  // @ts-ignore
  const options = component.options as ComponentOptions<Vue>;
  const props = options.props;
  if (isArray(props)) {
    return props.includes(prop);
  } else if (!props) {
    return false;
  } else {
    return Object.keys(props).includes(prop);
  }
}
</script>
<style lang="scss">
.lkt-dialog--modal {
  position: fixed !important;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 2;
  .lkt-dialog--header {
    height: 50px;
    line-height: 30px;
    padding: 10px;
    font-size: 1.1rem;
    text-align: center;
    position: relative;
    > .el-button {
      position: absolute;
      right: 10px;
      top: 10px;
    }
  }
  .lkt-dialog {
    display: inline-block;
    margin-top: 15vh;
    background-color: #fff;
    box-shadow: 1px 1px 5px rgba($color: #000, $alpha: .2);
    border-radius: 5px;
  }
  .lkt-dialog--body {
    padding: 20px;
  }
}
</style>

