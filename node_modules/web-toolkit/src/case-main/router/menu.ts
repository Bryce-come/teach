import { IMenuItem, storePageMenu } from '../';

// 用于菜单导航的顺序,name+icon
export function buildMenu(routes: any[], mainMenuTitles: any) {
  // 生成menu item
  const routeIndex = routes.filter((config) => config.name === 'index')[0];
  const children = routeIndex && routeIndex.children ? routeIndex.children : [];
  // menu: {title, privileges(all), children:[{cTitle, name, privileges}], }
  const menu: IMenuItem[] = [];
  for (const mainRouteItem of children) {
    // 不检测
    // @ts-ignore
    if (!mainRouteItem.meta || mainRouteItem.meta.parentName) { continue; }
    let title;
    let onlyMainTitle;
    // @ts-ignore
    if (mainRouteItem.meta.menuTitle) { title = mainRouteItem.meta.menuTitle; } else if (mainRouteItem.meta.parentCName) { title = mainRouteItem.meta.parentCName; } else if (mainRouteItem.meta.CName) {
      onlyMainTitle = true;
      // @ts-ignore
      title = mainRouteItem.meta.CName;
    }
    const i = mainMenuTitles.indexOf(title);
    if (i >= 0) {
      if (!menu[i / 2]) {
        menu[i / 2] = {
          title,
          icon: mainMenuTitles[i + 1],
        };
      }
      if (onlyMainTitle) {
        // 没有子导航
        // @ts-ignore
        menu[i / 2].cTitle = mainRouteItem.meta.CName;
        menu[i / 2].name = mainRouteItem.name;
        // @ts-ignore
        menu[i / 2].privileges = mainRouteItem.meta.privileges;
      } else {
        const children = menu[i / 2].children || [];
        if (children.length === 0) {
          menu[i / 2].children = children;
        }
        children.push({
          // @ts-ignore
          cTitle: mainRouteItem.meta.CName,
          name: mainRouteItem.name,
          // @ts-ignore
          privileges: mainRouteItem.meta.privileges,
        });
        // @ts-ignore
        if (mainRouteItem.meta.privileges) {
          const privileges = menu[i / 2].privileges || [];
          // @ts-ignore
          menu[i / 2].privileges = privileges.concat(mainRouteItem.meta.privileges);
        }
      }

    }
  }
  storePageMenu.push(...menu);
}
